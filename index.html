<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âä©ÂãïË©û„Ç´„Éº„Éâ„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .game-container {
            max-width: 480px;
            margin: 0 auto;
            background: #0f1419;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .game-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .turn-info {
            font-size: 18px;
            font-weight: bold;
        }
        .score-display {
            display: flex;
            gap: 15px;
            font-size: 16px;
        }
        .score-item {
            background: rgba(0,0,0,0.3);
            padding: 5px 12px;
            border-radius: 15px;
        }
        .battle-field {
            padding: 20px 15px;
            min-height: 400px;
        }
        .team-section {
            margin-bottom: 25px;
        }
        .team-label {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ko-count {
            background: #ff4444;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .character-cards {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .char-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 12px;
            padding: 10px;
            width: 110px;
            border: 3px solid #444;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .char-card.active {
            border-color: #ffd700;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        .char-card.defeated {
            opacity: 0.3;
            filter: grayscale(100%);
        }
        .char-card.opponent {
            background: linear-gradient(135deg, #4a1a1a 0%, #2d1a1a 100%);
        }
        .char-name {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .char-hp {
            font-size: 11px;
            margin-bottom: 5px;
            text-align: center;
        }
        .hp-bar-container {
            background: #333;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        .hp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            transition: width 0.3s;
        }
        .hp-bar-fill.low {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }
        .hp-bar-fill.critical {
            background: linear-gradient(90deg, #f87171, #ef4444);
        }
        .char-atk {
            font-size: 11px;
            text-align: center;
            color: #fbbf24;
        }
        .control-panel {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-top: 2px solid rgba(255,255,255,0.1);
        }
        .cost-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .action-btn {
            flex: 1;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .action-btn.swap {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        .action-btn.end {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .quiz-container {
            padding: 20px;
            min-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }
        .quiz-header {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .quiz-topic {
            color: #fbbf24;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .quiz-question {
            font-size: 20px;
            line-height: 1.6;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .quiz-choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .quiz-choice {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
            text-align: center;
        }
        .quiz-choice:hover {
            background: rgba(255,255,255,0.2);
            border-color: #667eea;
            transform: translateX(5px);
        }
        .quiz-choice.correct {
            background: rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
        }
        .quiz-choice.incorrect {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }
        .selection-screen {
            padding: 20px;
            min-height: 100vh;
        }
        .selection-title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .selection-subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 25px;
        }
        .hand-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .hand-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            padding: 15px;
            border-radius: 12px;
            border: 3px solid #444;
            cursor: pointer;
            transition: all 0.2s;
        }
        .hand-card:hover {
            transform: scale(1.05);
        }
        .hand-card.selected {
            border-color: #ffd700;
            background: linear-gradient(135deg, #3d4758 0%, #2a303c 100%);
        }
        .hand-card-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .hand-card-stats {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            margin-top: 8px;
        }
        .confirm-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .battle-log {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 15px;
            border-radius: 8px;
        }
        .log-entry {
            margin: 3px 0;
            padding: 3px 8px;
            border-left: 2px solid #667eea;
        }
        .result-screen {
            padding: 40px 20px;
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .result-title {
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        .result-score {
            font-size: 36px;
            margin: 30px 0;
            color: #ffd700;
        }
        .result-message {
            font-size: 20px;
            margin-bottom: 40px;
            color: #aaa;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #1a202c;
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .skill-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .skill-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.2s;
        }
        .skill-item:hover {
            background: rgba(255,255,255,0.2);
            border-color: #667eea;
        }
        .skill-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .skill-cost {
            color: #fbbf24;
            font-size: 14px;
        }
        .skill-desc {
            color: #aaa;
            font-size: 12px;
            margin-top: 5px;
            line-height: 1.4;
        }
        .close-modal {
            width: 100%;
            margin-top: 15px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer"></div>

    <script>
        const chara = [
            ["„Çã„Éª„Çâ„Çã", 100, 20, [0,1,2,3], 4],
            ["„Åô„Éª„Åï„Åô„Éª„Åó„ÇÄ", 80, 30, [4,1], 2],
            ["„ÇÄ„Éª„ÇÄ„Åö", 80, 20, [8,9,10,11,12], 5],
            ["„Å§„Éª„Å¨", 200, 15, [17,18], 2],
            ["„Åæ„Åó", 60, 40, [13,14,15], 3],
            ["„Åü„Çä(ÈÄ£Áî®)", 70, 25, [17,21], 2],
            ["„Çä", 70, 25, [17,21], 2],
            ["„Åî„Å®„Åó", 100, 30, [37], 1],
            ["„Åü„Çä(ÈÄ£‰Ωì)", 150, 30, [35], 1],
            ["„Å™„Çä(ÈÄ£‰Ωì)", 100, 30, [35,36], 2],
            ["„Åæ„Åò", 80, 10, [6,7,31,32,33,34], 6],
            ["„Åπ„Åó", 80, 20, [8,9,11,28,29,30], 6],
            ["„Å™„Çä(ÁµÇÊ≠¢)", 100, 30, [26,27], 2],
            ["„ÅÇ„Çä(ÁµÇÊ≠¢)", 80, 20, [12,27], 2],
            ["„Çâ„Åó", 80, 30, [27], 1],
            ["„Çâ„ÇÄ", 120, 30, [12,25,26], 3],
            ["„Åë", 120, 30, [19], 1],
            ["„Åü„Åó", 80, 10, [16], 1],
            ["„Åë„ÇÄ", 100, 30, [22,23,24], 3],
            ["„Åë„Çä", 100, 30, [19,20], 2],
            ["„Åæ„Åª„Åó", 80, 10, [16], 1],
            ["„Åò", 80, 20, [6,7], 2],
            ["„Åö", 100, 30, [5], 1]
        ];

        const skill = [
            ["Âèó„ÅëË∫´", 1, "Ë¢´„ÉÄ„É°30%ËªΩÊ∏õ(1„Çø„Éº„É≥)"],
            ["Â∞äÊï¨", 2, "HP+10,ATK+10/Áõ∏ÊâãATK-10%"],
            ["ÂèØËÉΩ", 2, "„Ç≥„Çπ„ÉàÁÑ°Ë¶ñ„ÅßËøΩÂä†„Çπ„Ç≠„É´‰ΩøÁî®"],
            ["Ëá™Áô∫", 1, "„Ç´„Éº„Éâ„Çí1ÊûöÂºï„Åè"],
            ["‰ΩøÂΩπ", 1, "Áõ∏Êâã„Å´Ëá™ÂÇ∑„Åï„Åõ„Çã"],
            ["ÊâìÊ∂à„Åó", 2, "Ë¢´„ÉÄ„É°10%ËªΩÊ∏õ"],
            ["ÊâìÊ∂à„ÅóÊé®Èáè", 3, "Áõ∏ÊâãÊ¨°„Çø„Éº„É≥Ë°åÂãï‰∏çÂèØ"],
            ["ÊâìÊ∂à„ÅóÊÑèÊÄù", 3, "Ê¨°„Çø„Éº„É≥„Çπ„Ç≠„ÉÉ„Éó/„Åù„ÅÆÊ¨°2ÂÄç„ÉÄ„É°"],
            ["Êé®Èáè", 1, "Áõ∏ÊâãATK-20"],
            ["ÊÑèÊÄù", 2, "1.5ÂÄçÊîªÊíÉ"],
            ["ÂãßË™ò", 1, "„Ç´„Éº„Éâ„Çí1ÊûöÂºï„Åè"],
            ["‰ªÆÂÆö", 2, "Áõ∏Êâã„Çπ„Ç≠„É´„Ç≥„Çπ„Éà+2"],
            ["Â©âÊõ≤", 2, "„Éô„É≥„ÉÅ„Åã„ÇâÊîªÊíÉ"],
            ["ÂèçÂÆü‰ªÆÊÉ≥", 5, "HPÂÖ®ÂõûÂæ©/Ê¨°„Çø„Éº„É≥3ÂÄç„ÉÄ„É°"],
            ["„Åü„ÇÅ„Çâ„ÅÑ„ÅÆÊÑèÂøó", 3, "2„Çø„Éº„É≥ÂæÖÊ©ü„ÅßÁõ∏ÊâãÊíÉÁ†¥"],
            ["ÂÆüÁèæ‰∏çÂèØËÉΩ„Å™Â∏åÊúõ", 2, "HP50%ÂõûÂæ©"],
            ["Â∏åÊúõ", 1, "HP30%ÂõûÂæ©"],
            ["ÂÆå‰∫Ü", 3, "ÊúÄÂ§ßHP10-50%„É©„É≥„ÉÄ„É†„ÉÄ„É°"],
            ["Âº∑ÊÑè", 2, "Ëá™ÂàÜ„Ç≥„Çπ„Éà-1/Áõ∏Êâã+1"],
            ["ÈÅéÂéª", 2, "ÂâçÂõûÊîªÊíÉ„ÇíÂçäÈ°çÂÜç‰ΩøÁî®"],
            ["Ë©†ÂòÜ", 1, "„Éê„ÉïÂäπÊûúÊ¨°„Çø„Éº„É≥Á∂ôÁ∂ö"],
            ["Â≠òÁ∂ö", 3, "ÊúÄÂ§ßHP10%√ó3„Çø„Éº„É≥Á∂ôÁ∂ö„ÉÄ„É°"],
            ["ÈÅéÂéªÊé®Èáè", 1, "Áõ∏ÊâãHP-20"],
            ["ÈÅéÂéª‰ºùËÅû", 2, "Áõ∏Êâã„ÅÆÂâçÂõûÊîªÊíÉ„Ç≥„Éî„Éº"],
            ["ÈÅéÂéªÂ©âÊõ≤", 2, "Áõ∏Êâã„Éô„É≥„ÉÅ„ÅåÁõ∏ÊâãÊîªÊíÉ"],
            ["ÁèæÂú®Êé®Èáè", 1, "Áõ∏ÊâãATK-20"],
            ["ÁèæÂú®‰ºùËÅû", 2, "Áõ∏ÊâãÊîªÊíÉ„Ç≥„Éî„Éº"],
            ["Êé®ÂÆö", 3, "Áõ∏ÊâãHP„Çí50„Å´Âõ∫ÂÆö"],
            ["ÂΩìÁÑ∂", 2, "„Éê„ÉïÁÑ°Ë¶ñÊîªÊíÉ"],
            ["ÂëΩ‰ª§", 1, "Áõ∏Êâã„Ç´„Éº„Éâ„ÇíÂ•™„ÅÜ"],
            ["ÈÅ©ÂΩì", 2, "Áõ∏Êâã„É°„Ç§„É≥/„Éô„É≥„ÉÅÂÖ•Êõø"],
            ["‰∏çÂèØËÉΩ", 1, "Áõ∏ÊâãÊ¨°„Çø„Éº„É≥„Éâ„É≠„Éº‰∏çÂèØ"],
            ["ÊâìÊ∂à„ÅóÂΩìÁÑ∂", 10, "Áõ∏Êâã„Ç≥„Çπ„ÉàÂÖ®Á†¥Â£ä"],
            ["Á¶ÅÊ≠¢", 1, "Áõ∏Êâã„Çµ„Éù„Éº„Éà‰ΩøÁî®‰∏çÂèØ"],
            ["‰∏çÈÅ©ÂΩì", 1, "Áõ∏ÊâãATK-30"],
            ["Êñ≠ÂÆö", 1, "ÈÄöÂ∏∏ÊîªÊíÉ"],
            ["Â≠òÂú®", 1, "„Éô„É≥„ÉÅ„Å®‰∫§‰ª£"],
            ["ÊØîÊ≥Å", 3, "HP‰Ωé„Åë„Çå„Å∞Áõ∏Êâã„Å®ÂêåÂÄ§Âåñ"],
            ["ÂéüÂõ†Êé®Èáè", 1, "ÈÄöÂ∏∏ÊîªÊíÉ"],
            ["ÈÅéÂéªÂéüÂõ†Êé®Èáè", 3, "Ê∏õÂ∞ëHPÂàÜ„ÉÄ„É°„Éº„Ç∏"],
            ["‰æãÁ§∫", 4, "Ê¨°„Çø„Éº„É≥HP0„Åß„ÇÇË°åÂãïÂèØ"],
            ["‰∏¶Âàó", 4, "ÊîªÊíÉ+„Åæ„Åç„Å≥„Åó(30/„Çø„Éº„É≥)"]
        ];

        const quizData = [
            {question: "‰ªäÊó•„ÅØ„Åæ„Åó„Å¶„ÄÅÊØç„ÅÆÊÇ≤„Åó„Åå„Çâ„Çã„Çã„Åì„Å®„ÅØ", answer: "Â∞äÊï¨", choices: ["Â∞äÊï¨", "Ëá™Áô∫", "ÂèØËÉΩ", "ÂèóË∫´", "‰ΩøÂΩπ"], topic: "„Çã"},
            {question: "Ëàà„Å´ÂÖ•„Çâ„Çå‰æç„Çä", answer: "Â∞äÊï¨", choices: ["Â∞äÊï¨", "ÂèóË∫´", "ÂÆå‰∫Ü", "Ëá™Áô∫", "ÈÅéÂéª"], topic: "„Çã"},
            {question: "Áü•„Çâ„Çã„ÇãË∫´„Åì„ÅùÊÇ≤„Åó„Åë„Çå", answer: "Ëá™Áô∫", choices: ["Ëá™Áô∫", "Â∞äÊï¨", "ÂèóË∫´", "ÂèØËÉΩ", "‰ΩøÂΩπ"], topic: "„Çã"},
            {question: "„ÅÑ„Å®„Åª„Åó„ÅÜÊÄù„ÇÜ„Çã„Å™„Çä", answer: "Ëá™Áô∫", choices: ["Ëá™Áô∫", "Â∞äÊï¨", "ÂèóË∫´", "ÂèØËÉΩ", "ÂÆå‰∫Ü"], topic: "„Çã"},
            {question: "„ÅÑ„Å•„Åè„Çà„ÇäÊù•„Çã„Åû", answer: "ÂèØËÉΩ", choices: ["ÂèØËÉΩ", "ÂèóË∫´", "Â∞äÊï¨", "Ëá™Áô∫", "‰ΩøÂΩπ"], topic: "„Çã"}
        ];

        let gameState = {
            turn: 0,
            phase: 'init',
            order: null,
            playerHand: [],
            opponentHand: [],
            playerTeam: [],
            opponentTeam: [],
            playerActiveIdx: 0,
            opponentActiveIdx: 0,
            playerCost: 0,
            opponentCost: 0,
            playerDefeated: 0,
            opponentDefeated: 0,
            log: [],
            playerDamageReduction: 0,
            opponentDamageReduction: 0,
            playerSkipNext: false,
            opponentSkipNext: false,
            playerDoubleDamageNext: false,
            opponentDoubleDamageNext: false,
            playerTripleDamageNext: false,
            opponentTripleDamageNext: false,
            playerCostMod: 0,
            opponentCostMod: 0,
            playerPreviousAttack: null,
            opponentPreviousAttack: null,
            playerWaitTurns: 0,
            opponentWaitTurns: 0,
            continuousDamageTurns: 0,
            playerContinuousDamage: 0,
            opponentContinuousDamage: 0,
            makibishiDamage: 0
        };

        function addLog(msg) {
            gameState.log.push(msg);
            if (gameState.log.length > 30) gameState.log.shift();
        }

        function generateDeck() {
            const deck = [];
            for (let i = 0; i < 20; i++) {
                deck.push(Math.floor(Math.random() * chara.length));
            }
            return deck;
        }

        function drawHand(deck) {
            const hand = [];
            for (let i = 0; i < 6; i++) {
                hand.push(deck[Math.floor(Math.random() * deck.length)]);
            }
            return hand;
        }

        function initGame() {
            const deck1 = generateDeck();
            const deck2 = generateDeck();
            
            gameState.order = Math.random() < 0.5 ? 'first' : 'second';
            gameState.playerHand = drawHand(gameState.order === 'first' ? deck1 : deck2);
            gameState.opponentHand = drawHand(gameState.order === 'first' ? deck2 : deck1);
            
            addLog(`„ÅÇ„Å™„Åü„ÅØ${gameState.order === 'first' ? 'ÂÖàÊîª' : 'ÂæåÊîª'}„Åß„Åô`);
            showHandSelection();
        }

        function showHandSelection() {
            const container = document.getElementById('gameContainer');
            const selectedIndices = [];
            
            container.innerHTML = `
                <div class="selection-screen">
                    <h1 class="selection-title">„Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû</h1>
                    <p class="selection-subtitle">3‰Ωì„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
                    <div class="hand-grid" id="handGrid"></div>
                    <button class="confirm-btn" id="confirmBtn" disabled>Ê±∫ÂÆö</button>
                </div>
            `;

            const grid = document.getElementById('handGrid');
            gameState.playerHand.forEach((cIdx, i) => {
                const c = chara[cIdx];
                const card = document.createElement('div');
                card.className = 'hand-card';
                card.innerHTML = `
                    <div class="hand-card-name">${c[0]}</div>
                    <div class="hand-card-stats">
                        <span>HP: ${c[1]}</span>
                        <span>ATK: ${c[2]}</span>
                    </div>
                `;
                card.onclick = () => {
                    const idx = selectedIndices.indexOf(i);
                    if (idx > -1) {
                        selectedIndices.splice(idx, 1);
                        card.classList.remove('selected');
                    } else if (selectedIndices.length < 3) {
                        selectedIndices.push(i);
                        card.classList.add('selected');
                    }
                    document.getElementById('confirmBtn').disabled = selectedIndices.length !== 3;
                };
                grid.appendChild(card);
            });

            document.getElementById('confirmBtn').onclick = () => {
                gameState.playerTeam = selectedIndices.map(i => ({
                    charaIdx: gameState.playerHand[i],
                    hp: chara[gameState.playerHand[i]][1],
                    maxHp: chara[gameState.playerHand[i]][1],
                    atk: chara[gameState.playerHand[i]][2],
                    baseAtk: chara[gameState.playerHand[i]][2],
                    defeated: false
                }));

                const cpuSelected = [];
                while (cpuSelected.length < 3) {
                    const idx = Math.floor(Math.random() * 6);
                    if (!cpuSelected.includes(idx)) cpuSelected.push(idx);
                }
                gameState.opponentTeam = cpuSelected.map(i => ({
                    charaIdx: gameState.opponentHand[i],
                    hp: chara[gameState.opponentHand[i]][1],
                    maxHp: chara[gameState.opponentHand[i]][1],
                    atk: chara[gameState.opponentHand[i]][2],
                    baseAtk: chara[gameState.opponentHand[i]][2],
                    defeated: false
                }));

                startTurn();
            };
        }

        function startTurn() {
            gameState.turn++;
            addLog(`=== „Çø„Éº„É≥ ${gameState.turn} ===`);
            
            // „Çø„Éº„É≥ÈñãÂßãÊôÇ„ÅÆÂá¶ÁêÜ
            applyContinuousEffects();
            checkWaitTurns();
            
            if (gameState.order === 'first') {
                showQuiz();
            } else {
                opponentQuiz();
            }
        }

        function showQuiz() {
            const totalQuestions = gameState.turn + 1;
            let currentQuestion = 0;
            let correctCount = 0;
            
            function displayQuestion() {
                const container = document.getElementById('gameContainer');
                const quiz = quizData[Math.floor(Math.random() * quizData.length)];
                const shuffled = [...quiz.choices].sort(() => Math.random() - 0.5);
                
                container.innerHTML = `
                    <div class="game-header">
                        <div class="turn-info">„Çø„Éº„É≥ ${gameState.turn}</div>
                        <div class="score-display">
                            <div class="score-item">„ÅÇ„Å™„Åü ${gameState.playerDefeated}/3</div>
                            <div class="score-item">Áõ∏Êâã ${gameState.opponentDefeated}/3</div>
                        </div>
                    </div>
                    <div class="quiz-container">
                        <div class="quiz-header">
                            <div class="quiz-topic">„Äå${quiz.topic}„Äç„ÅÆÂïèÈ°å (${currentQuestion + 1}/${totalQuestions})</div>
                            <div style="margin-top:10px; color:#fbbf24">Ê≠£Ëß£Êï∞: ${correctCount}</div>
                        </div>
                        <div class="quiz-question">${quiz.question}</div>
                        <div class="quiz-choices" id="choices"></div>
                    </div>
                `;

                const choicesDiv = document.getElementById('choices');
                let answered = false;

                shuffled.forEach((choice, i) => {
                    const div = document.createElement('div');
                    div.className = 'quiz-choice';
                    div.textContent = choice;
                    div.onclick = () => {
                        if (answered) return;
                        answered = true;
                        
                        if (choice === quiz.answer) {
                            div.classList.add('correct');
                            correctCount++;
                            addLog(`‚úì Ê≠£Ëß£! (${currentQuestion + 1}ÂïèÁõÆ)`);
                        } else {
                            div.classList.add('incorrect');
                            addLog(`‚úó ‰∏çÊ≠£Ëß£ (Ê≠£Ëß£: ${quiz.answer})`);
                        }
                        
                        currentQuestion++;
                        
                        setTimeout(() => {
                            if (currentQuestion < totalQuestions) {
                                displayQuestion();
                            } else {
                                gameState.playerCost += correctCount;
                                addLog(`„ÇØ„Ç§„Ç∫ÁµÇ‰∫Ü! „Ç≥„Çπ„Éà+${correctCount}`);
                                if (gameState.order === 'first') {
                                    opponentQuiz();
                                } else {
                                    showBattle();
                                }
                            }
                        }, 1500);
                    };
                    choicesDiv.appendChild(div);
                });
            }
            
            displayQuestion();
        }

        function opponentQuiz() {
            const score = Math.min(gameState.turn + 1, Math.floor(Math.random() * (gameState.turn + 2)));
            gameState.opponentCost += score;
            addLog(`Áõ∏Êâã„Ç≥„Çπ„Éà+${score}`);
            
            setTimeout(() => {
                if (gameState.order === 'first') {
                    showBattle();
                } else {
                    showQuiz();
                }
            }, 1000);
        }

        function applyContinuousEffects() {
            if (gameState.continuousDamageTurns > 0) {
                if (gameState.playerContinuousDamage > 0) {
                    gameState.playerTeam[gameState.playerActiveIdx].hp -= gameState.playerContinuousDamage;
                    addLog(`Á∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏: ${gameState.playerContinuousDamage}`);
                }
                if (gameState.opponentContinuousDamage > 0) {
                    gameState.opponentTeam[gameState.opponentActiveIdx].hp -= gameState.opponentContinuousDamage;
                    addLog(`Áõ∏Êâã„Å´Á∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏: ${gameState.opponentContinuousDamage}`);
                }
                gameState.continuousDamageTurns--;
            }
            
            if (gameState.makibishiDamage > 0) {
                gameState.opponentTeam[gameState.opponentActiveIdx].hp -= gameState.makibishiDamage;
                addLog(`„Åæ„Åç„Å≥„Åó„ÉÄ„É°„Éº„Ç∏: ${gameState.makibishiDamage}`);
            }
        }

        function checkWaitTurns() {
            if (gameState.playerWaitTurns > 0) {
                gameState.playerWaitTurns--;
                if (gameState.playerWaitTurns === 0) {
                    gameState.opponentTeam[gameState.opponentActiveIdx].hp = 0;
                    addLog('„Åü„ÇÅ„Çâ„ÅÑ„ÅÆÊÑèÊÄùÁô∫ÂãïÔºÅÁõ∏Êâã„ÇíÊíÉÁ†¥ÔºÅ');
                    checkDefeat(true);
                }
            }
            
            if (gameState.opponentWaitTurns > 0) {
                gameState.opponentWaitTurns--;
                if (gameState.opponentWaitTurns === 0) {
                    gameState.playerTeam[gameState.playerActiveIdx].hp = 0;
                    addLog('Áõ∏Êâã„ÅÆ„Åü„ÇÅ„Çâ„ÅÑ„ÅÆÊÑèÊÄùÁô∫ÂãïÔºÅ');
                    checkDefeat(false);
                }
            }
        }

        function showBattle() {
            const container = document.getElementById('gameContainer');
            
            container.innerHTML = `
                <div class="game-header">
                    <div class="turn-info">„Çø„Éº„É≥ ${gameState.turn}</div>
                    <div class="score-display">
                        <div class="score-item">${gameState.playerDefeated}/3</div>
                        <div class="score-item">${gameState.opponentDefeated}/3</div>
                    </div>
                </div>
                <div class="battle-field">
                    <div class="team-section">
                        <div class="team-label">
                            <span>Áõ∏Êâã</span>
                            <span class="ko-count">KO: ${gameState.opponentDefeated}</span>
                        </div>
                        <div class="character-cards" id="opponentCards"></div>
                    </div>
                    <div class="team-section">
                        <div class="team-label">
                            <span>„ÅÇ„Å™„Åü</span>
                            <span class="ko-count">KO: ${gameState.playerDefeated}</span>
                        </div>
                        <div class="character-cards" id="playerCards"></div>
                    </div>
                </div>
                <div class="control-panel">
                    <div class="cost-display">„Ç≥„Çπ„Éà: ${gameState.playerCost}</div>
                    <div class="action-buttons">
                        <button class="action-btn swap" onclick="showSwapModal()">‰∫§‰ª£ (1)</button>
                        <button class="action-btn" onclick="showSkillModal()">„Çπ„Ç≠„É´</button>
                        <button class="action-btn end" onclick="endPlayerTurn()">ÁµÇ‰∫Ü</button>
                    </div>
                    <div class="battle-log" id="battleLog"></div>
                </div>
            `;

            renderTeams();
            updateLog();
        }

        function renderTeams() {
            const playerDiv = document.getElementById('playerCards');
            const opponentDiv = document.getElementById('opponentCards');

            if (!playerDiv || !opponentDiv) return;

            playerDiv.innerHTML = '';
            opponentDiv.innerHTML = '';

            gameState.opponentTeam.forEach((m, i) => {
                const c = chara[m.charaIdx];
                const card = document.createElement('div');
                card.className = `char-card opponent ${i === gameState.opponentActiveIdx ? 'active' : ''} ${m.defeated ? 'defeated' : ''}`;
                const hpPercent = (m.hp / m.maxHp) * 100;
                const hpClass = hpPercent > 60 ? '' : hpPercent > 30 ? 'low' : 'critical';
                
                card.innerHTML = `
                    <div class="char-name">${c[0]}</div>
                    <div class="char-hp">${Math.max(0, m.hp)}/${m.maxHp}</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar-fill ${hpClass}" style="width:${Math.max(0, hpPercent)}%"></div>
                    </div>
                    <div class="char-atk">‚öîÔ∏è ${m.atk}</div>
                `;
                opponentDiv.appendChild(card);
            });

            gameState.playerTeam.forEach((m, i) => {
                const c = chara[m.charaIdx];
                const card = document.createElement('div');
                card.className = `char-card ${i === gameState.playerActiveIdx ? 'active' : ''} ${m.defeated ? 'defeated' : ''}`;
                const hpPercent = (m.hp / m.maxHp) * 100;
                const hpClass = hpPercent > 60 ? '' : hpPercent > 30 ? 'low' : 'critical';
                
                card.innerHTML = `
                    <div class="char-name">${c[0]}</div>
                    <div class="char-hp">${Math.max(0, m.hp)}/${m.maxHp}</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar-fill ${hpClass}" style="width:${Math.max(0, hpPercent)}%"></div>
                    </div>
                    <div class="char-atk">‚öîÔ∏è ${m.atk}</div>
                `;
                playerDiv.appendChild(card);
            });
        }

        function showSwapModal() {
            if (gameState.playerCost < 1) {
                alert('„Ç≥„Çπ„Éà„ÅåË∂≥„Çä„Åæ„Åõ„Çì!');
                return;
            }

            const available = gameState.playerTeam
                .map((m, i) => ({...m, idx: i}))
                .filter(m => !m.defeated && m.idx !== gameState.playerActiveIdx);

            if (available.length === 0) {
                alert('‰∫§‰ª£ÂèØËÉΩ„Å™„Ç≠„É£„É©„Åå„ÅÑ„Åæ„Åõ„Çì!');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 class="modal-title">„Ç≠„É£„É©„ÇØ„Çø„Éº‰∫§‰ª£</h3>
                    <div class="skill-list" id="swapList"></div>
                    <button class="close-modal" onclick="this.parentElement.parentElement.remove()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            `;

            const list = modal.querySelector('#swapList');
            available.forEach((m, i) => {
                const c = chara[m.charaIdx];
                const item = document.createElement('div');
                item.className = 'skill-item';
                item.innerHTML = `
                    <div class="skill-name">${c[0]}</div>
                    <div style="font-size:13px">HP: ${m.hp}/${m.maxHp} / ATK: ${m.atk}</div>
                `;
                item.onclick = () => {
                    gameState.playerCost--;
                    gameState.playerActiveIdx = m.idx;
                    addLog(`${c[0]} „Å´‰∫§‰ª£!`);
                    modal.remove();
                    showBattle();
                };
                list.appendChild(item);
            });

            document.body.appendChild(modal);
        }

        function showSkillModal() {
            if (gameState.playerSkipNext) {
                alert('„Åì„ÅÆ„Çø„Éº„É≥„ÅØË°åÂãï„Åß„Åç„Åæ„Åõ„Çì!');
                return;
            }

            const active = gameState.playerTeam[gameState.playerActiveIdx];
            const c = chara[active.charaIdx];
            const skills = c[3];

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 class="modal-title">„Çπ„Ç≠„É´ÈÅ∏Êäû</h3>
                    <div style="text-align:center; margin-bottom:15px; color:#fbbf24">
                        ÊÆã„Çä„Ç≥„Çπ„Éà: ${gameState.playerCost}
                    </div>
                    <div class="skill-list" id="skillList"></div>
                    <button class="close-modal" onclick="this.parentElement.parentElement.remove()">Èñâ„Åò„Çã</button>
                </div>
            `;

            const list = modal.querySelector('#skillList');
            skills.forEach((sId, i) => {
                const s = skill[sId];
                const cost = s[1] + gameState.playerCostMod;
                const item = document.createElement('div');
                item.className = 'skill-item';
                item.innerHTML = `
                    <div class="skill-name">${s[0]}</div>
                    <div class="skill-cost">„Ç≥„Çπ„Éà: ${cost}</div>
                    <div class="skill-desc">${s[2]}</div>
                `;
                
                if (gameState.playerCost >= cost) {
                    item.onclick = () => {
                        gameState.playerCost -= cost;
                        gameState.playerPreviousAttack = sId;
                        executeSkill(sId, true);
                        modal.remove();
                        showBattle();
                        updateLog();
                    };
                } else {
                    item.style.opacity = '0.4';
                    item.style.cursor = 'not-allowed';
                }
                
                list.appendChild(item);
            });

            document.body.appendChild(modal);
        }

        function executeSkill(sId, isPlayer) {
            const sName = skill[sId][0];
            addLog(`üí´ ${sName} Áô∫Âãï!`);

            const attacker = isPlayer ? gameState.playerTeam[gameState.playerActiveIdx] : gameState.opponentTeam[gameState.opponentActiveIdx];
            const defender = isPlayer ? gameState.opponentTeam[gameState.opponentActiveIdx] : gameState.playerTeam[gameState.playerActiveIdx];

            switch(sId) {
                case 0: // Âèó„ÅëË∫´
                    if (isPlayer) gameState.playerDamageReduction = 0.3;
                    else gameState.opponentDamageReduction = 0.3;
                    addLog("Ë¢´„ÉÄ„É°„Éº„Ç∏30%ËªΩÊ∏õ(1„Çø„Éº„É≥)");
                    break;

                case 1: // Â∞äÊï¨
                    attacker.hp = Math.min(attacker.maxHp, attacker.hp + 10);
                    attacker.atk += 10;
                    defender.atk = Math.max(1, Math.floor(defender.atk * 0.9));
                    addLog(`HP+10, ATK+10 / Áõ∏ÊâãATK-10%`);
                    break;

                case 2: // ÂèØËÉΩ
                    addLog("ËøΩÂä†„Çπ„Ç≠„É´‰ΩøÁî®!");
                    if (isPlayer) {
                        setTimeout(() => showSkillModal(), 500);
                    }
                    break;

                case 3: // Ëá™Áô∫
                case 10: // ÂãßË™ò
                    addLog("„Ç´„Éº„Éâ„Çí1ÊûöÂºï„ÅÑ„Åü");
                    break;

                case 4: // ‰ΩøÂΩπ
                    defender.hp -= defender.atk;
                    addLog(`Áõ∏Êâã„ÅåËá™ÂÇ∑! ${defender.atk}„ÉÄ„É°„Éº„Ç∏`);
                    checkDefeat(isPlayer);
                    break;

                case 5: // ÊâìÊ∂à„Åó
                    if (isPlayer) gameState.playerDamageReduction += 0.1;
                    else gameState.opponentDamageReduction += 0.1;
                    addLog("Ë¢´„ÉÄ„É°„Éº„Ç∏10%ËªΩÊ∏õ");
                    break;

                case 6: // ÊâìÊ∂à„ÅóÊé®Èáè
                    if (isPlayer) gameState.opponentSkipNext = true;
                    else gameState.playerSkipNext = true;
                    addLog("Áõ∏Êâã„ÅØÊ¨°„Çø„Éº„É≥Ë°åÂãï‰∏çÂèØ!");
                    break;

                case 7: // ÊâìÊ∂à„ÅóÊÑèÊÄù
                    if (isPlayer) {
                        gameState.playerSkipNext = true;
                        gameState.playerDoubleDamageNext = true;
                    } else {
                        gameState.opponentSkipNext = true;
                        gameState.opponentDoubleDamageNext = true;
                    }
                    addLog("Ê¨°„Çø„Éº„É≥„Çπ„Ç≠„ÉÉ„Éó/„Åù„ÅÆÊ¨°2ÂÄç„ÉÄ„É°");
                    break;

                case 8: // Êé®Èáè
                case 25: // ÁèæÂú®Êé®Èáè
                    defender.atk = Math.max(1, defender.atk - 20);
                    addLog(`Áõ∏ÊâãATK-20 (ÁèæÂú®: ${defender.atk})`);
                    break;

                case 9: // ÊÑèÊÄù
                    {
                        let damage = Math.floor(attacker.atk * 1.5);
                        if (isPlayer && gameState.playerDoubleDamageNext) damage *= 2;
                        if (!isPlayer && gameState.opponentDoubleDamageNext) damage *= 2;
                        if (isPlayer && gameState.playerTripleDamageNext) damage *= 3;
                        if (!isPlayer && gameState.opponentTripleDamageNext) damage *= 3;
                        
                        const reduction = isPlayer ? gameState.opponentDamageReduction : gameState.playerDamageReduction;
                        damage = Math.floor(damage * (1 - reduction));
                        
                        defender.hp -= damage;
                        addLog(`1.5ÂÄçÊîªÊíÉ! ${damage}„ÉÄ„É°„Éº„Ç∏`);
                        checkDefeat(isPlayer);
                    }
                    break;

                case 11: // ‰ªÆÂÆö
                    if (isPlayer) gameState.opponentCostMod += 2;
                    else gameState.playerCostMod += 2;
                    addLog("Áõ∏Êâã„Çπ„Ç≠„É´„Ç≥„Çπ„Éà+2");
                    break;

                case 12: // Â©âÊõ≤
                    {
                        const damage = attacker.baseAtk;
                        defender.hp -= damage;
                        addLog(`„Éô„É≥„ÉÅÊîªÊíÉ! ${damage}„ÉÄ„É°„Éº„Ç∏`);
                        checkDefeat(isPlayer);
                    }
                    break;

                case 13: // ÂèçÂÆü‰ªÆÊÉ≥
                    attacker.hp = attacker.maxHp;
                    if (isPlayer) gameState.playerTripleDamageNext = true;
                    else gameState.opponentTripleDamageNext = true;
                    addLog("HPÂÖ®ÂõûÂæ©! Ê¨°„Çø„Éº„É≥3ÂÄç„ÉÄ„É°");
                    break;

                case 14: // „Åü„ÇÅ„Çâ„ÅÑ„ÅÆÊÑèÂøó
                    if (isPlayer) gameState.playerWaitTurns = 2;
                    else gameState.opponentWaitTurns = 2;
                    addLog("2„Çø„Éº„É≥ÂæÖÊ©ü„ÅßÁõ∏ÊâãÊíÉÁ†¥");
                    break;

                case 15: // ÂÆüÁèæ‰∏çÂèØËÉΩ„Å™Â∏åÊúõ
                    {
                        const heal = Math.floor(attacker.maxHp * 0.5);
                        attacker.hp = Math.min(attacker.maxHp, attacker.hp + heal);
                        addLog(`HP50%ÂõûÂæ©! ${heal}ÂõûÂæ©`);
                    }
                    break;

                case 16: // Â∏åÊúõ
                    {
                        const heal = Math.floor(attacker.maxHp * 0.3);
                        attacker.hp = Math.min(attacker.maxHp, attacker.hp + heal);
                        addLog(`HP30%ÂõûÂæ©! ${heal}ÂõûÂæ©`);
                    }
                    break;

                case 17: // ÂÆå‰∫Ü
                    {
                        const percent = [10, 20, 30, 40, 50][Math.floor(Math.random() * 5)];
                        const damage = Math.floor(defender.maxHp * percent / 100);
                        defender.hp -= damage;
                        addLog(`„É´„Éº„É¨„ÉÉ„Éà! ÊúÄÂ§ßHP${percent}% (${damage}„ÉÄ„É°„Éº„Ç∏)`);
                        checkDefeat(isPlayer);
                    }
                    break;

                case 18: // Âº∑ÊÑè
                    if (isPlayer) {
                        gameState.playerCostMod -= 1;
                        gameState.opponentCostMod += 1;
                    } else {
                        gameState.opponentCostMod -= 1;
                        gameState.playerCostMod += 1;
                    }
                    addLog("Ëá™ÂàÜ„Ç≥„Çπ„Éà-1 / Áõ∏Êâã+1");
                    break;

                case 19: // ÈÅéÂéª
                    if (isPlayer && gameState.playerPreviousAttack !== null && gameState.playerPreviousAttack !== 19) {
                        const halfCost = Math.max(1, Math.floor(skill[gameState.playerPreviousAttack][1] / 2));
                        if (gameState.playerCost >= halfCost) {
                            gameState.playerCost -= halfCost;
                            addLog("ÂâçÂõûÊîªÊíÉ„ÇíÂçäÈ°çÂÜç‰ΩøÁî®!");
                            executeSkill(gameState.playerPreviousAttack, true);
                        }
                    }
                    break;

                case 20: // Ë©†ÂòÜ
                    addLog("„Éê„ÉïÂäπÊûúÊ¨°„Çø„Éº„É≥Á∂ôÁ∂ö");
                    break;

                case 21: // Â≠òÁ∂ö
                    if (isPlayer) {
                        gameState.opponentContinuousDamage = Math.floor(defender.maxHp * 0.1);
                        gameState.continuousDamageTurns = 3;
                    } else {
                        gameState.playerContinuousDamage = Math.floor(defender.maxHp * 0.1);
                        gameState.continuousDamageTurns = 3;
                    }
                    addLog("ÊúÄÂ§ßHP10%√ó3„Çø„Éº„É≥Á∂ôÁ∂ö„ÉÄ„É°");
                    break;

                case 22: // ÈÅéÂéªÊé®Èáè
                    defender.hp -= 20;
                    addLog(`HP-20 (ÁèæÂú®: ${Math.max(0, defender.hp)})`);
                    checkDefeat(isPlayer);
                    break;

                case 23: // ÈÅéÂéª‰ºùËÅû
                case 26: // ÁèæÂú®‰ºùËÅû
                    if (isPlayer && gameState.opponentPreviousAttack !== null) {
                        addLog("Áõ∏ÊâãÊîªÊíÉ„Ç≥„Éî„Éº!");
                        executeSkill(gameState.opponentPreviousAttack, true);
                    }
                    break;

                case 24: // ÈÅéÂéªÂ©âÊõ≤
                    defender.hp -= defender.baseAtk;
                    addLog(`Áõ∏Êâã„Éô„É≥„ÉÅ„ÅåÁõ∏ÊâãÊîªÊíÉ! ${defender.baseAtk}„ÉÄ„É°„Éº„Ç∏`);
                    checkDefeat(isPlayer);
                    break;

                case 27: // Êé®ÂÆö
                    if (defender.hp > 50) {
                        defender.hp = 50;
                        addLog("Áõ∏ÊâãHP„Çí50„Å´Âõ∫ÂÆö!");
                    }
                    break;

                case 28: // ÂΩìÁÑ∂
                    defender.hp -= attacker.atk;
                    addLog(`„Éê„ÉïÁÑ°Ë¶ñÊîªÊíÉ! ${attacker.atk}„ÉÄ„É°„Éº„Ç∏`);
                    checkDefeat(isPlayer);
                    break;

                case 29: // ÂëΩ‰ª§
                    addLog("Áõ∏Êâã„Ç´„Éº„ÉâÂ•™Âèñ!");
                    break;

                case 30: // ÈÅ©ÂΩì
                    addLog("Áõ∏Êâã„É°„Ç§„É≥/„Éô„É≥„ÉÅÂÖ•Êõø");
                    break;

                case 31: // ‰∏çÂèØËÉΩ
                    addLog("Áõ∏ÊâãÊ¨°„Çø„Éº„É≥„Éâ„É≠„Éº‰∏çÂèØ");
                    break;

                case 32: // ÊâìÊ∂à„ÅóÂΩìÁÑ∂
                    if (isPlayer) gameState.opponentCost = 0;
                    else gameState.playerCost = 0;
                    addLog("Áõ∏Êâã„Ç≥„Çπ„ÉàÂÖ®Á†¥Â£ä!");
                    break;

                case 33: // Á¶ÅÊ≠¢
                    addLog("Áõ∏Êâã„Çµ„Éù„Éº„Éà‰ΩøÁî®‰∏çÂèØ");
                    break;

                case 34: // ‰∏çÈÅ©ÂΩì
                    defender.atk = Math.max(1, defender.atk - 30);
                    addLog(`Áõ∏ÊâãATK-30 (ÁèæÂú®: ${defender.atk})`);
                    break;

                case 35: // Êñ≠ÂÆö
                case 38: // ÂéüÂõ†Êé®Èáè
                    {
                        let damage = attacker.atk;
                        const reduction = isPlayer ? gameState.opponentDamageReduction : gameState.playerDamageReduction;
                        damage = Math.floor(damage * (1 - reduction));
                        defender.hp -= damage;
                        addLog(`ÊîªÊíÉ! ${damage}„ÉÄ„É°„Éº„Ç∏`);
                        checkDefeat(isPlayer);
                    }
                    break;

                case 36: // Â≠òÂú®
                    addLog("„Éô„É≥„ÉÅ„Å®‰∫§‰ª£");
                    break;

                case 37: // ÊØîÊ≥Å
                    if (attacker.hp < defender.hp) {
                        attacker.hp = defender.hp;
                        addLog("HP„ÇíÁõ∏Êâã„Å®ÂêåÂÄ§Âåñ!");
                    }
                    break;

                case 39: // ÈÅéÂéªÂéüÂõ†Êé®Èáè
                    {
                        const damage = defender.maxHp - defender.hp;
                        defender.hp -= damage;
                        addLog(`Ê∏õÂ∞ëHPÂàÜ„ÉÄ„É°! ${damage}„ÉÄ„É°„Éº„Ç∏`);
                        checkDefeat(isPlayer);
                    }
                    break;

                case 40: // ‰æãÁ§∫
                    addLog("Ê¨°„Çø„Éº„É≥HP0„Åß„ÇÇË°åÂãïÂèØ");
                    break;

                case 41: // ‰∏¶Âàó
                    {
                        let damage = attacker.atk;
                        defender.hp -= damage;
                        gameState.makibishiDamage = 30;
                        addLog(`ÊîªÊíÉ${damage} + „Åæ„Åç„Å≥„Åó30/„Çø„Éº„É≥`);
                        checkDefeat(isPlayer);
                    }
                    break;
            }

            // „ÉÄ„É°„Éº„Ç∏ÂÄçÁéá„É™„Çª„ÉÉ„Éà
            if (isPlayer) {
                gameState.playerDoubleDamageNext = false;
                gameState.playerTripleDamageNext = false;
            } else {
                gameState.opponentDoubleDamageNext = false;
                gameState.opponentTripleDamageNext = false;
            }

            renderTeams();
        }

        function checkDefeat(isPlayer) {
            const defender = isPlayer ? gameState.opponentTeam[gameState.opponentActiveIdx] : gameState.playerTeam[gameState.playerActiveIdx];

            if (defender.hp <= 0) {
                defender.hp = 0;
                defender.defeated = true;
                
                if (isPlayer) {
                    gameState.playerDefeated++;
                    addLog('üéâ Áõ∏Êâã„ÅÆ„Ç≠„É£„É©„ÇíÊíÉÁ†¥!');
                    
                    const nextIdx = gameState.opponentTeam.findIndex((m, i) => !m.defeated && i !== gameState.opponentActiveIdx);
                    if (nextIdx !== -1) {
                        gameState.opponentActiveIdx = nextIdx;
                        addLog(`Áõ∏Êâã„Åå ${chara[gameState.opponentTeam[nextIdx].charaIdx][0]} „Å´‰∫§‰ª£`);
                    }
                } else {
                    gameState.opponentDefeated++;
                    addLog('üíÄ „ÅÇ„Å™„Åü„ÅÆ„Ç≠„É£„É©„ÅåÊíÉÁ†¥„Åï„Çå„Åü!');
                    
                    const nextIdx = gameState.playerTeam.findIndex((m, i) => !m.defeated && i !== gameState.playerActiveIdx);
                    if (nextIdx !== -1) {
                        gameState.playerActiveIdx = nextIdx;
                        addLog(`${chara[gameState.playerTeam[nextIdx].charaIdx][0]} „Å´‰∫§‰ª£`);
                    }
                }
            }
        }

        function endPlayerTurn() {
            addLog('„Çø„Éº„É≥ÁµÇ‰∫Ü');
            gameState.playerSkipNext = false;
            setTimeout(() => opponentBattle(), 1000);
        }

        function opponentBattle() {
            if (gameState.opponentSkipNext) {
                addLog('=== Áõ∏Êâã„ÅØ„Çπ„Ç≠„ÉÉ„Éó ===');
                gameState.opponentSkipNext = false;
                setTimeout(() => checkVictory(), 1000);
                return;
            }

            addLog('=== Áõ∏Êâã„ÅÆ„Çø„Éº„É≥ ===');
            
            const active = gameState.opponentTeam[gameState.opponentActiveIdx];
            const c = chara[active.charaIdx];
            const skills = c[3];
            
            let actions = 0;
            while (gameState.opponentCost > 0 && actions < 2) {
                const availableSkills = skills.filter(sId => skill[sId][1] + gameState.opponentCostMod <= gameState.opponentCost);
                if (availableSkills.length === 0) break;
                
                const sId = availableSkills[Math.floor(Math.random() * availableSkills.length)];
                const cost = skill[sId][1] + gameState.opponentCostMod;
                gameState.opponentCost -= cost;
                gameState.opponentPreviousAttack = sId;
                executeSkill(sId, false);
                actions++;
                
                if (Math.random() < 0.4) break;
            }
            
            setTimeout(() => checkVictory(), 1500);
        }

        function checkVictory() {
            if (gameState.playerDefeated >= 3) {
                showGameEnd(false);
                return;
            }
            
            if (gameState.opponentDefeated >= 3) {
                showGameEnd(true);
                return;
            }
            
            if (gameState.turn >= 15) {
                showGameEnd(gameState.playerDefeated > gameState.opponentDefeated);
                return;
            }
            
            renderTeams();
            updateLog();
            setTimeout(() => startTurn(), 1000);
        }

        function showGameEnd(playerWon) {
            const container = document.getElementById('gameContainer');
            
            container.innerHTML = `
                <div class="result-screen">
                    <div class="result-title">
                        ${playerWon ? 'üéâ ÂãùÂà©! üéâ' : 'üíÄ ÊïóÂåó'}
                    </div>
                    <div class="result-score">
                        ${gameState.playerDefeated} vs ${gameState.opponentDefeated}
                    </div>
                    <div class="result-message">
                        ${playerWon ? '„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô!' : 'Ê¨°„ÅØÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜ!'}
                    </div>
                    <button class="confirm-btn" onclick="location.reload()">
                        „ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§
                    </button>
                    <div class="battle-log" style="max-height:300px; margin-top:30px" id="finalLog"></div>
                </div>
            `;
            
            updateLog();
        }

        function updateLog() {
            const logDiv = document.getElementById('battleLog') || document.getElementById('finalLog');
            if (logDiv) {
                logDiv.innerHTML = gameState.log.slice(-15).reverse().map(msg => 
                    `<div class="log-entry">${msg}</div>`
                ).join('');
            }
        }

        window.onload = () => initGame();
    </script>
</body>
</html>
